<script setup lang="ts">
const router = useRouter();

const errorStore = useErrorStore();

const error = ref(errorStore.activeError);

const message = ref('');
const customCode = ref(0);
const details = ref('');
const code = ref('');
const hint = ref('');
const statusCode = ref(0);
const stack = ref('');

if (error.value && !('code' in error.value)) {
    message.value = error.value.message;
    customCode.value = error.value.customCode ?? 0;
    stack.value = error.value.stack ?? '';
}

if (error.value && 'code' in error.value) {
    message.value = error.value.message;
    details.value = error.value.details;
    hint.value = error.value.hint;
    code.value = error.value.code;
    statusCode.value = error.value.statusCode ?? 0;
}

const ErrorTemplate = import.meta.env.DEV
    ? defineAsyncComponent(() => import('./AppErrorDevSection.vue'))
    : defineAsyncComponent(() => import('./AppErrorProdSection.vue'));

router.afterEach(() => {
    errorStore.clearError();
});
</script>
<template>
    <section class="error">
        <ErrorTemplate
            :message
            :customCode
            :code
            :statusCode
            :hint
            :details
            :stack
            :isCustomError="errorStore.isCustomError"
        />
    </section>
</template>
<style scoped>
.error {
    @apply mx-auto flex justify-center items-center flex-1 p-10 text-center -mt-20 min-h-[90vh];
}

:deep(.error__icon) {
    @apply text-7xl text-destructive;
}

:deep(.error__code) {
    @apply font-extrabold text-7xl text-secondary;
}

:deep(.error__status) {
    @apply font-bold text-5xl text-secondary;
}

:deep(.error__msg) {
    @apply text-3xl font-bold text-primary first-letter:capitalize;
}

:deep(.error__stack) {
    @apply text-left whitespace-pre-wrap font-mono leading-10 bg-secondary rounded-xl;
}

:deep(.error__stack h3) {
    @apply border-b border-background p-4;
}

:deep(.error__stack p) {
    @apply p-4;
}

:deep(.error__stack p:first-line) {
    @apply bg-background;
}

:deep(.error-footer) {
    @apply flex flex-col items-center justify-center gap-5 mt-6 font-light;
}

:deep(.error-footer__text) {
    @apply text-lg text-muted-foreground;
}

:deep(p) {
    @apply my-2;
}
</style>
